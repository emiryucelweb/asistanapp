import{a as e,al as s,u as t,am as a,r,l as i,af as l,j as n,P as o,m as c,n as d,t as m,f as h,F as u,ad as x,d as b,i as p,I as g,q as w,a1 as v,p as f,a3 as j,a2 as N,an as y,ao as k,a4 as C}from"./index-BDKevNej.js";import{C as S}from"./chevron-up-BpnJatgQ.js";const I="http://localhost:3001",$="/api/v1/appointments",D="/api/v1/ai/ask",A=5e3,T="authToken",P=()=>{const{t:P,i18n:E}=e("agent"),{id:F}=s(),O=t(),{activeCall:q}=a(),[z,R]=r.useState(!0),[M,H]=r.useState(0),[B,J]=r.useState(!1),[Q,K]=r.useState(!0),[V,W]=r.useState(!1),[_,G]=r.useState(!0),[L,U]=r.useState(""),[X,Y]=r.useState(!0),[Z,ee]=r.useState(!1),[se,te]=r.useState(""),[ae,re]=r.useState(""),[ie,le]=r.useState(!1),[ne,oe]=r.useState(null),[ce,de]=r.useState(!1),[me,he]=r.useState(!1),[ue,xe]=r.useState(!1),[be,pe]=r.useState({date:"",time:"",duration:String(60),service:"",notes:""});i.debug("ðŸ“ž VoiceCallScreen loaded, Conversation ID:",{conversationId:F}),r.useEffect(()=>{(async()=>{try{i.debug("ðŸ”Œ Connecting to call...",{conversationId:F}),await new Promise(e=>setTimeout(e,2e3+1e3*Math.random())),R(!1),i.debug("âœ… Connection established!")}catch(e){i.error("âŒ Connection error:",e),R(!1),l.error(P("voice.connectionFailed")),setTimeout(()=>O("/agent/conversations"),2e3)}})()},[F,O,P]),r.useEffect(()=>{if(z)return;const e=setInterval(()=>{H(e=>e+1)},1e3);return()=>clearInterval(e)},[z]);const ge=q?{name:q.customerName,phone:q.customerPhone,email:q.customerEmail,avatar:q.customerAvatar,previousIssues:[]}:{name:"Customer",phone:"",email:"",avatar:void 0,previousIssues:[]},we=(null==q?void 0:q.messages)||[];r.useEffect(()=>{if(!L.trim())return;const e=setTimeout(()=>{ve()},A);return()=>clearTimeout(e)},[L]);const ve=async()=>{if(L.trim()){de(!0);try{i.debug("Saving notes:",{conversationId:F,notes:L}),await new Promise(e=>setTimeout(e,500)),oe(new Date),i.debug("Notes saved successfully")}catch(e){i.error("Failed to save notes:",e),l.error(P("voiceCall.notesSaveFailed"))}finally{de(!1)}}},fe=async()=>{if(se.trim()){le(!0),re("");try{i.debug("AI Assistant question:",{question:se,conversationId:F,customerId:ge.phone});const e=localStorage.getItem(T),s=await fetch(`${I}${D}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({question:se,conversationId:F,customerId:ge.phone,context:{callDuration:M,notes:L,conversationHistory:we.slice(-5)}})});if(!s.ok)throw new Error("AI API request failed");const t=await s.json();re(t.answer||t.response||P("voiceCall.aiNoResponse")),("create_appointment"===t.suggestedAction||t.isAppointmentRequest)&&he(!0),l.success(P("voiceCall.aiResponseReady"))}catch(e){i.error("AI question failed:",e),l.error(P("voiceCall.aiResponseFailed"))}finally{le(!1)}}else l.error(P("voiceCall.pleaseWriteQuestion"))};return n.jsxs("div",{className:"fixed inset-0 bg-gradient-to-br from-blue-600 via-blue-700 to-purple-700 dark:from-slate-800 dark:via-slate-900 dark:to-slate-950 z-50 overflow-hidden",children:[z&&n.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center",children:n.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 text-center",children:[n.jsx("div",{className:"flex justify-center mb-4",children:n.jsxs("div",{className:"relative w-16 h-16 flex items-center justify-center",children:[n.jsx("div",{className:"flex items-center justify-center gap-1",children:[0,1,2].map(e=>n.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600 dark:bg-blue-400 animate-bounce",style:{animationDelay:.15*e+"s",animationDuration:"0.6s"}},e))}),n.jsx(o,{className:"w-8 h-8 text-blue-600 dark:text-blue-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"})]})}),n.jsx("h3",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:P("voice.connecting")}),n.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:P("voice.connectingDescription")}),n.jsxs("div",{className:"flex items-center justify-center gap-1",children:[n.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),n.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),n.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]})}),n.jsx("div",{className:"bg-white/10 dark:bg-white/5 backdrop-blur-md border-b border-white/20 dark:border-white/10 p-2 sm:p-3",children:n.jsxs("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[n.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0",children:ge.avatar?n.jsx("img",{src:ge.avatar,alt:ge.name,className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full"}):n.jsx(c,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})}),n.jsxs("div",{className:"min-w-0",children:[n.jsx("h2",{className:"text-base sm:text-lg font-bold text-white truncate",children:ge.name}),n.jsx("p",{className:"text-white/70 text-xs truncate",children:ge.phone})]})]}),n.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:n.jsxs("div",{className:"text-center",children:[n.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 text-white/90",children:[n.jsx(d,{className:"w-3 h-3 sm:w-4 sm:h-4"}),n.jsx("span",{className:"text-xl sm:text-2xl font-mono font-bold",children:(e=>{const s=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`})(M)})]}),n.jsx("div",{className:"text-white/60 text-xs hidden sm:block",children:V?`â¸ï¸ ${P("conversations.voiceCall.onHold")}`:`ðŸ”´ ${P("conversations.voiceCall.active")}`})]})})]})}),n.jsx("div",{className:"max-w-6xl mx-auto p-2 sm:p-3 h-[calc(100vh-140px)] sm:h-[calc(100vh-140px)] overflow-y-auto",children:n.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-2 sm:gap-3",children:[n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-white/20 dark:border-white/10",children:[n.jsxs("button",{type:"button",onClick:()=>Y(!X),className:"w-full flex items-center justify-between mb-2",children:[n.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-white",children:[n.jsx(m,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),n.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:P("conversations.voiceCall.aiHistory")})]}),X?n.jsx(S,{className:"w-4 h-4 text-white"}):n.jsx(h,{className:"w-4 h-4 text-white"})]}),X&&n.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:we.map(e=>n.jsxs("div",{className:"p-2 rounded-lg "+("customer"===e.sender?"bg-white/20":"bg-blue-500/30"),children:[n.jsx("div",{className:"flex items-center gap-1 mb-1",children:n.jsx("span",{className:"text-xs text-white/60",children:e.senderName})}),n.jsx("p",{className:"text-xs text-white/90 line-clamp-2",children:e.content})]},e.id))})]}),n.jsxs("div",{className:"bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-white/20 dark:border-white/10",children:[n.jsx("div",{className:"flex items-center justify-between mb-2",children:n.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-white",children:[n.jsx(u,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),n.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:P("conversations.voiceCall.notesTitle")}),ce&&n.jsx("div",{className:"flex items-center justify-center gap-0.5",children:[0,1,2].map(e=>n.jsx("div",{className:"w-0.5 h-0.5 rounded-full bg-blue-300 animate-bounce",style:{animationDelay:.15*e+"s",animationDuration:"0.6s"}},e))})]})}),n.jsx("textarea",{value:L,onChange:e=>U(e.target.value),placeholder:P("voiceCall.notesPlaceholder"),className:"w-full h-24 sm:h-32 bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded-lg p-2 text-xs sm:text-sm text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-white/50 dark:focus:ring-white/30 resize-none"}),ne&&n.jsxs("div",{className:"mt-1 text-xs text-white/50",children:["âœ“ ",x(ne,E.language)]})]}),n.jsxs("div",{className:"bg-amber-500/20 dark:bg-amber-500/10 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-amber-400/30 dark:border-amber-400/20",children:[n.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-amber-100 mb-2",children:[n.jsx(b,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),n.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:P("conversations.voiceCall.previousIssues")})]}),n.jsx("ul",{className:"space-y-1",children:ge.previousIssues.map((e,s)=>n.jsxs("li",{className:"text-xs text-amber-50/90",children:["â€¢ ",e]},s))})]})]}),n.jsx("div",{className:"lg:col-span-2",children:n.jsxs("div",{className:"bg-gradient-to-br from-purple-500/20 to-pink-500/20 dark:from-purple-500/10 dark:to-pink-500/10 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-purple-400/30 dark:border-purple-400/20 h-full",children:[n.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-white mb-2 sm:mb-3",children:[n.jsx(p,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),n.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:P("conversations.voiceCall.aiAssistantTitle")}),n.jsx(g,{className:"w-3 h-3 text-yellow-300"})]}),n.jsxs("div",{className:"flex gap-1.5 sm:gap-2 mb-2 sm:mb-3",children:[n.jsx("input",{type:"text",value:se,onChange:e=>te(e.target.value),onKeyPress:e=>{"Enter"!==e.key||ie||fe()},placeholder:P("voiceCall.askQuestionPlaceholder"),className:"flex-1 px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded-lg text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500",disabled:ie}),n.jsx("button",{type:"button",onClick:fe,disabled:ie||!se.trim(),className:"px-3 py-2 bg-purple-500 hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 disabled:bg-gray-500 dark:disabled:bg-gray-600 disabled:opacity-50 text-white rounded-lg transition-colors",children:ie?n.jsx("div",{className:"flex items-center justify-center gap-0.5 w-4 h-4",children:[0,1,2].map(e=>n.jsx("div",{className:"w-1 h-1 rounded-full bg-white animate-bounce",style:{animationDelay:.15*e+"s",animationDuration:"0.6s"}},e))}):n.jsx(w,{className:"w-4 h-4"})})]}),ie&&n.jsx("div",{className:"bg-white/10 dark:bg-white/5 border border-purple-300/30 dark:border-purple-300/20 rounded-lg p-3 mb-3",children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"flex items-center justify-center gap-0.5",children:[0,1,2].map(e=>n.jsx("div",{className:"w-1 h-1 rounded-full bg-purple-300 animate-bounce",style:{animationDelay:.15*e+"s",animationDuration:"0.6s"}},e))}),n.jsx("span",{className:"text-sm text-purple-200",children:P("conversations.voiceCall.thinking")})]})}),ae&&!ie&&n.jsxs("div",{className:"bg-white/10 dark:bg-white/5 border border-purple-300/30 dark:border-purple-300/20 rounded-lg p-3 mb-3",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx(p,{className:"w-3 h-3 text-purple-300"}),n.jsx("span",{className:"text-xs text-purple-200 font-semibold",children:P("conversations.voiceCall.response")})]}),n.jsx("p",{className:"text-white/90 text-sm",children:ae})]}),me&&n.jsxs("div",{className:"bg-green-500/20 dark:bg-green-500/10 border border-green-400/30 dark:border-green-400/20 rounded-lg p-3",children:[n.jsxs("div",{className:"flex items-center justify-between mb-2",children:[n.jsxs("h4",{className:"text-sm font-semibold text-white flex items-center gap-2",children:["ðŸ“… ",P("conversations.voiceCall.createAppointment")]}),n.jsx("button",{type:"button",onClick:()=>he(!1),className:"text-white/60 hover:text-white",children:"âœ•"})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[n.jsx("input",{type:"date",value:be.date,onChange:e=>pe({...be,date:e.target.value}),className:"px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500"}),n.jsx("input",{type:"time",value:be.time,onChange:e=>pe({...be,time:e.target.value}),className:"px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500"})]}),n.jsx("input",{type:"text",placeholder:P("voiceCall.serviceOptional"),value:be.service,onChange:e=>pe({...be,service:e.target.value}),className:"w-full px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500"}),n.jsx("textarea",{placeholder:P("voiceCall.noteOptional"),value:be.notes,onChange:e=>pe({...be,notes:e.target.value}),rows:2,className:"w-full px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500 resize-none"}),n.jsx("button",{type:"button",onClick:async()=>{if(be.date&&be.time){xe(!0);try{i.debug("Creating appointment:",be);const e=await fetch(`${I}${$}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem(T)}`},body:JSON.stringify({customerId:ge.phone.replace(/\s/g,""),customerName:ge.name,customerPhone:ge.phone,customerEmail:ge.email,appointmentDate:be.date,appointmentTime:be.time,duration:parseInt(be.duration)||60,service:be.service,notes:be.notes,conversationId:F})});if(!e.ok)throw new Error(P("voiceCall.appointmentCreateFailed"));const s=await e.json();i.debug("Appointment created successfully:",s),l.success(P("voiceCall.appointmentCreated")),pe({date:"",time:"",duration:String(60),service:"",notes:""}),he(!1),U(e=>`${e}\n\nâœ… ${P("conversations.voiceCall.createAppointment")}:\n- ${P("common:common.labels.date")}: ${be.date}\n- ${P("common:common.labels.time")}: ${be.time}\n- ${P("voiceCall.serviceOptional")}: ${be.service||P("common:common.labels.notSpecified")}\n- ${P("voiceCall.noteOptional")}: ${be.notes||P("common:common.labels.none")}`)}catch(e){i.error("Failed to create appointment:",e),l.error(e instanceof Error?e.message:P("voiceCall.appointmentCreateFailed"))}finally{xe(!1)}}else l.error(P("voiceCall.selectDateTime"))},disabled:ue||!be.date||!be.time,className:"w-full px-3 py-2 bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 disabled:bg-gray-500 dark:disabled:bg-gray-600 disabled:opacity-50 text-white text-sm rounded-lg transition-colors flex items-center justify-center gap-2",children:ue?n.jsx("div",{className:"flex items-center justify-center gap-0.5",children:[0,1,2].map(e=>n.jsx("div",{className:"w-1 h-1 rounded-full bg-white animate-bounce",style:{animationDelay:.15*e+"s",animationDuration:"0.6s"}},e))}):n.jsx(n.Fragment,{children:n.jsx("span",{children:P("conversations.voiceCall.createAppointment")})})})]})]})]})})]})}),n.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-white/10 dark:bg-white/5 backdrop-blur-md border-t border-white/20 dark:border-white/10 p-2 sm:p-3",children:n.jsxs("div",{className:"max-w-6xl mx-auto flex items-center justify-center gap-2 sm:gap-3",children:[n.jsx("button",{type:"button",onClick:()=>{J(!B)},className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center transition-all "+(B?"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700":"bg-white/20 hover:bg-white/30 dark:bg-white/10 dark:hover:bg-white/20"),title:P(B?"voiceCall.unmuteMic":"voiceCall.muteMic"),children:B?n.jsx(v,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):n.jsx(f,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),n.jsx("button",{type:"button",onClick:()=>{K(!Q)},className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center transition-all "+(Q?"bg-white/20 hover:bg-white/30 dark:bg-white/10 dark:hover:bg-white/20":"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700"),title:P(Q?"voiceCall.muteSpeaker":"voiceCall.unmuteSpeaker"),children:Q?n.jsx(j,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):n.jsx(N,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),n.jsx("button",{type:"button",onClick:()=>{W(!V)},className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center transition-all "+(V?"bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700":"bg-white/20 hover:bg-white/30 dark:bg-white/10 dark:hover:bg-white/20"),title:P(V?"conversations.voiceCall.continue":"conversations.voiceCall.hold"),children:V?n.jsx(y,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):n.jsx(k,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),n.jsx("button",{type:"button",onClick:()=>{O("/agent/conversations")},className:"w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 flex items-center justify-center transition-all shadow-lg hover:scale-105 transform",title:P("voiceCall.end"),children:n.jsx(C,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})})]})})]})};export{P as default};
