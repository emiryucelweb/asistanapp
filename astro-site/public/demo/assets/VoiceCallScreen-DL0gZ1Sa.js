import{ac as ae,l as o,a6 as d,j as e,P as re,g as ne,h as ie,o as oe,b as le,F as ce,a4 as de,a as me,e as _,y as he,m as ue,V as xe,k as pe,Y as be,W as ge,ad as we,ae as ve,Z as fe}from"./index-BqAy8n8z.js";import{r}from"./vendor-CdXbigxo.js";import{u as Ne}from"./i18n-CvUHAAnz.js";import{d as je,a as ke}from"./router-Bk68T6VO.js";import{C as ye}from"./chevron-up-CjEhd2qx.js";import"./charts-CyRV38jT.js";const M="http://localhost:3001",R={APPOINTMENTS:"/api/v1/appointments",SAVE_NOTES:"/api/v1/conversations/:id/notes",ASK_AI:"/api/v1/ai/ask",CUSTOMER_INFO:"/api/v1/customers/:customerId",CUSTOMER_HISTORY:"/api/v1/customers/:customerId/history"},Ce={NOTE_SAVE_DELAY:5e3},F={AUTH_TOKEN:"authToken",REFRESH_TOKEN:"refreshToken",TENANT_ID:"tenantId"},H=60,Me=()=>{const{t:s,i18n:U}=Ne("agent"),{id:m}=je(),v=ke(),{activeCall:l}=ae(),[f,k]=r.useState(!0),[y,K]=r.useState(0),[g,V]=r.useState(!1),[w,q]=r.useState(!0),[x,z]=r.useState(!1),[Se,Ae]=r.useState(!0),[h,C]=r.useState(""),[N,L]=r.useState(!0),[Ie,Te]=r.useState(!1),[p,Y]=r.useState(""),[S,A]=r.useState(""),[u,I]=r.useState(!1),[T,B]=r.useState(null),[Q,E]=r.useState(!1),[G,j]=r.useState(!1),[O,D]=r.useState(!1),[a,b]=r.useState({date:"",time:"",duration:String(H),service:"",notes:""});o.debug("ðŸ“ž VoiceCallScreen loaded, Conversation ID:",{conversationId:m}),r.useEffect(()=>{(async()=>{try{o.debug("ðŸ”Œ Connecting to call...",{conversationId:m}),await new Promise(n=>setTimeout(n,2e3+Math.random()*1e3)),k(!1),o.debug("âœ… Connection established!")}catch(n){o.error("âŒ Connection error:",n),k(!1),d.error(s("voice.connectionFailed")),setTimeout(()=>v("/agent/conversations"),2e3)}})()},[m,v,s]),r.useEffect(()=>{if(f)return;const t=setInterval(()=>{K(n=>n+1)},1e3);return()=>clearInterval(t)},[f]);const J=t=>{const n=Math.floor(t/60),c=t%60;return`${n.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`},i=l?{name:l.customerName,phone:l.customerPhone,email:l.customerEmail,avatar:l.customerAvatar,previousIssues:[]}:{name:"Customer",phone:"",email:"",avatar:void 0,previousIssues:[]},$=(l==null?void 0:l.messages)||[];r.useEffect(()=>{if(!h.trim())return;const t=setTimeout(()=>{W()},Ce.NOTE_SAVE_DELAY);return()=>clearTimeout(t)},[h]);const W=async()=>{if(h.trim()){E(!0);try{o.debug("Saving notes:",{conversationId:m,notes:h}),await new Promise(t=>setTimeout(t,500)),B(new Date),o.debug("Notes saved successfully")}catch(t){o.error("Failed to save notes:",t),d.error(s("voiceCall.notesSaveFailed"))}finally{E(!1)}}},P=async()=>{if(!p.trim()){d.error(s("voiceCall.pleaseWriteQuestion"));return}I(!0),A("");try{o.debug("AI Assistant question:",{question:p,conversationId:m,customerId:i.phone});const t=localStorage.getItem(F.AUTH_TOKEN),n=await fetch(`${M}${R.ASK_AI}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({question:p,conversationId:m,customerId:i.phone,context:{callDuration:y,notes:h,conversationHistory:$.slice(-5)}})});if(!n.ok)throw new Error("AI API request failed");const c=await n.json();A(c.answer||c.response||s("voiceCall.aiNoResponse")),(c.suggestedAction==="create_appointment"||c.isAppointmentRequest)&&j(!0),d.success(s("voiceCall.aiResponseReady"))}catch(t){o.error("AI question failed:",t),d.error(s("voiceCall.aiResponseFailed"))}finally{I(!1)}},X=async()=>{if(!a.date||!a.time){d.error(s("voiceCall.selectDateTime"));return}D(!0);try{o.debug("Creating appointment:",a);const t=await fetch(`${M}${R.APPOINTMENTS}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem(F.AUTH_TOKEN)}`},body:JSON.stringify({customerId:i.phone.replace(/\s/g,""),customerName:i.name,customerPhone:i.phone,customerEmail:i.email,appointmentDate:a.date,appointmentTime:a.time,duration:parseInt(a.duration)||60,service:a.service,notes:a.notes,conversationId:m})});if(!t.ok)throw new Error(s("voiceCall.appointmentCreateFailed"));const n=await t.json();o.debug("Appointment created successfully:",n),d.success(s("voiceCall.appointmentCreated")),b({date:"",time:"",duration:String(H),service:"",notes:""}),j(!1),C(c=>`${c}

âœ… ${s("conversations.voiceCall.createAppointment")}:
- ${s("common:common.labels.date")}: ${a.date}
- ${s("common:common.labels.time")}: ${a.time}
- ${s("voiceCall.serviceOptional")}: ${a.service||s("common:common.labels.notSpecified")}
- ${s("voiceCall.noteOptional")}: ${a.notes||s("common:common.labels.none")}`)}catch(t){o.error("Failed to create appointment:",t),d.error(t instanceof Error?t.message:s("voiceCall.appointmentCreateFailed"))}finally{D(!1)}},Z=()=>{v("/agent/conversations")},ee=()=>{V(!g)},te=()=>{q(!w)},se=()=>{z(!x)};return e.jsxs("div",{className:"fixed inset-0 bg-gradient-to-br from-blue-600 via-blue-700 to-purple-700 dark:from-slate-800 dark:via-slate-900 dark:to-slate-950 z-50 overflow-hidden",children:[f&&e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 text-center",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsxs("div",{className:"relative w-16 h-16 flex items-center justify-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1",children:[0,1,2].map(t=>e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600 dark:bg-blue-400 animate-bounce",style:{animationDelay:`${t*.15}s`,animationDuration:"0.6s"}},t))}),e.jsx(re,{className:"w-8 h-8 text-blue-600 dark:text-blue-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"})]})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:s("voice.connecting")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:s("voice.connectingDescription")}),e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]})}),e.jsx("div",{className:"bg-white/10 dark:bg-white/5 backdrop-blur-md border-b border-white/20 dark:border-white/10 p-2 sm:p-3",children:e.jsxs("div",{className:"max-w-6xl mx-auto flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0",children:i.avatar?e.jsx("img",{src:i.avatar,alt:i.name,className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full"}):e.jsx(ne,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold text-white truncate",children:i.name}),e.jsx("p",{className:"text-white/70 text-xs truncate",children:i.phone})]})]}),e.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 text-white/90",children:[e.jsx(ie,{className:"w-3 h-3 sm:w-4 sm:h-4"}),e.jsx("span",{className:"text-xl sm:text-2xl font-mono font-bold",children:J(y)})]}),e.jsx("div",{className:"text-white/60 text-xs hidden sm:block",children:x?`â¸ï¸ ${s("conversations.voiceCall.onHold")}`:`ðŸ”´ ${s("conversations.voiceCall.active")}`})]})})]})}),e.jsx("div",{className:"max-w-6xl mx-auto p-2 sm:p-3 h-[calc(100vh-140px)] sm:h-[calc(100vh-140px)] overflow-y-auto",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-2 sm:gap-3",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-white/20 dark:border-white/10",children:[e.jsxs("button",{type:"button",onClick:()=>L(!N),className:"w-full flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-white",children:[e.jsx(oe,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),e.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:s("conversations.voiceCall.aiHistory")})]}),N?e.jsx(ye,{className:"w-4 h-4 text-white"}):e.jsx(le,{className:"w-4 h-4 text-white"})]}),N&&e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:$.map(t=>e.jsxs("div",{className:`p-2 rounded-lg ${t.sender==="customer"?"bg-white/20":"bg-blue-500/30"}`,children:[e.jsx("div",{className:"flex items-center gap-1 mb-1",children:e.jsx("span",{className:"text-xs text-white/60",children:t.senderName})}),e.jsx("p",{className:"text-xs text-white/90 line-clamp-2",children:t.content})]},t.id))})]}),e.jsxs("div",{className:"bg-white/10 dark:bg-white/5 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-white/20 dark:border-white/10",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-white",children:[e.jsx(ce,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),e.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:s("conversations.voiceCall.notesTitle")}),Q&&e.jsx("div",{className:"flex items-center justify-center gap-0.5",children:[0,1,2].map(t=>e.jsx("div",{className:"w-0.5 h-0.5 rounded-full bg-blue-300 animate-bounce",style:{animationDelay:`${t*.15}s`,animationDuration:"0.6s"}},t))})]})}),e.jsx("textarea",{value:h,onChange:t=>C(t.target.value),placeholder:s("voiceCall.notesPlaceholder"),className:"w-full h-24 sm:h-32 bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded-lg p-2 text-xs sm:text-sm text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-white/50 dark:focus:ring-white/30 resize-none"}),T&&e.jsxs("div",{className:"mt-1 text-xs text-white/50",children:["âœ“ ",de(T,U.language)]})]}),e.jsxs("div",{className:"bg-amber-500/20 dark:bg-amber-500/10 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-amber-400/30 dark:border-amber-400/20",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-amber-100 mb-2",children:[e.jsx(me,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),e.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:s("conversations.voiceCall.previousIssues")})]}),e.jsx("ul",{className:"space-y-1",children:i.previousIssues.map((t,n)=>e.jsxs("li",{className:"text-xs text-amber-50/90",children:["â€¢ ",t]},n))})]})]}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"bg-gradient-to-br from-purple-500/20 to-pink-500/20 dark:from-purple-500/10 dark:to-pink-500/10 backdrop-blur-md rounded-lg sm:rounded-xl p-2 sm:p-3 border border-purple-400/30 dark:border-purple-400/20 h-full",children:[e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-white mb-2 sm:mb-3",children:[e.jsx(_,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4"}),e.jsx("h3",{className:"text-xs sm:text-sm font-semibold",children:s("conversations.voiceCall.aiAssistantTitle")}),e.jsx(he,{className:"w-3 h-3 text-yellow-300"})]}),e.jsxs("div",{className:"flex gap-1.5 sm:gap-2 mb-2 sm:mb-3",children:[e.jsx("input",{type:"text",value:p,onChange:t=>Y(t.target.value),onKeyPress:t=>{t.key==="Enter"&&!u&&P()},placeholder:s("voiceCall.askQuestionPlaceholder"),className:"flex-1 px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded-lg text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-purple-400 dark:focus:ring-purple-500",disabled:u}),e.jsx("button",{type:"button",onClick:P,disabled:u||!p.trim(),className:"px-3 py-2 bg-purple-500 hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 disabled:bg-gray-500 dark:disabled:bg-gray-600 disabled:opacity-50 text-white rounded-lg transition-colors",children:u?e.jsx("div",{className:"flex items-center justify-center gap-0.5 w-4 h-4",children:[0,1,2].map(t=>e.jsx("div",{className:"w-1 h-1 rounded-full bg-white animate-bounce",style:{animationDelay:`${t*.15}s`,animationDuration:"0.6s"}},t))}):e.jsx(ue,{className:"w-4 h-4"})})]}),u&&e.jsx("div",{className:"bg-white/10 dark:bg-white/5 border border-purple-300/30 dark:border-purple-300/20 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex items-center justify-center gap-0.5",children:[0,1,2].map(t=>e.jsx("div",{className:"w-1 h-1 rounded-full bg-purple-300 animate-bounce",style:{animationDelay:`${t*.15}s`,animationDuration:"0.6s"}},t))}),e.jsx("span",{className:"text-sm text-purple-200",children:s("conversations.voiceCall.thinking")})]})}),S&&!u&&e.jsxs("div",{className:"bg-white/10 dark:bg-white/5 border border-purple-300/30 dark:border-purple-300/20 rounded-lg p-3 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(_,{className:"w-3 h-3 text-purple-300"}),e.jsx("span",{className:"text-xs text-purple-200 font-semibold",children:s("conversations.voiceCall.response")})]}),e.jsx("p",{className:"text-white/90 text-sm",children:S})]}),G&&e.jsxs("div",{className:"bg-green-500/20 dark:bg-green-500/10 border border-green-400/30 dark:border-green-400/20 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h4",{className:"text-sm font-semibold text-white flex items-center gap-2",children:["ðŸ“… ",s("conversations.voiceCall.createAppointment")]}),e.jsx("button",{type:"button",onClick:()=>j(!1),className:"text-white/60 hover:text-white",children:"âœ•"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"date",value:a.date,onChange:t=>b({...a,date:t.target.value}),className:"px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500"}),e.jsx("input",{type:"time",value:a.time,onChange:t=>b({...a,time:t.target.value}),className:"px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500"})]}),e.jsx("input",{type:"text",placeholder:s("voiceCall.serviceOptional"),value:a.service,onChange:t=>b({...a,service:t.target.value}),className:"w-full px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500"}),e.jsx("textarea",{placeholder:s("voiceCall.noteOptional"),value:a.notes,onChange:t=>b({...a,notes:t.target.value}),rows:2,className:"w-full px-2 py-1 text-sm bg-white/20 dark:bg-white/10 border border-white/30 dark:border-white/20 rounded text-white placeholder-white/50 dark:placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-green-400 dark:focus:ring-green-500 resize-none"}),e.jsx("button",{type:"button",onClick:X,disabled:O||!a.date||!a.time,className:"w-full px-3 py-2 bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 disabled:bg-gray-500 dark:disabled:bg-gray-600 disabled:opacity-50 text-white text-sm rounded-lg transition-colors flex items-center justify-center gap-2",children:O?e.jsx("div",{className:"flex items-center justify-center gap-0.5",children:[0,1,2].map(t=>e.jsx("div",{className:"w-1 h-1 rounded-full bg-white animate-bounce",style:{animationDelay:`${t*.15}s`,animationDuration:"0.6s"}},t))}):e.jsx(e.Fragment,{children:e.jsx("span",{children:s("conversations.voiceCall.createAppointment")})})})]})]})]})})]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-white/10 dark:bg-white/5 backdrop-blur-md border-t border-white/20 dark:border-white/10 p-2 sm:p-3",children:e.jsxs("div",{className:"max-w-6xl mx-auto flex items-center justify-center gap-2 sm:gap-3",children:[e.jsx("button",{type:"button",onClick:ee,className:`w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center transition-all ${g?"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700":"bg-white/20 hover:bg-white/30 dark:bg-white/10 dark:hover:bg-white/20"}`,title:s(g?"voiceCall.unmuteMic":"voiceCall.muteMic"),children:g?e.jsx(xe,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):e.jsx(pe,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),e.jsx("button",{type:"button",onClick:te,className:`w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center transition-all ${w?"bg-white/20 hover:bg-white/30 dark:bg-white/10 dark:hover:bg-white/20":"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700"}`,title:s(w?"voiceCall.muteSpeaker":"voiceCall.unmuteSpeaker"),children:w?e.jsx(be,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):e.jsx(ge,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),e.jsx("button",{type:"button",onClick:se,className:`w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center transition-all ${x?"bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700":"bg-white/20 hover:bg-white/30 dark:bg-white/10 dark:hover:bg-white/20"}`,title:s(x?"conversations.voiceCall.continue":"conversations.voiceCall.hold"),children:x?e.jsx(we,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"}):e.jsx(ve,{className:"w-4 h-4 sm:w-5 sm:h-5 text-white"})}),e.jsx("button",{type:"button",onClick:Z,className:"w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 flex items-center justify-center transition-all shadow-lg hover:scale-105 transform",title:s("voiceCall.end"),children:e.jsx(fe,{className:"w-5 h-5 sm:w-6 sm:h-6 text-white"})})]})})]})};export{Me as default};
//# sourceMappingURL=VoiceCallScreen-DL0gZ1Sa.js.map
